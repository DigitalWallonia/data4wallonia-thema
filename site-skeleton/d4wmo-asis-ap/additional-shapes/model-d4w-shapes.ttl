@prefix : <https://www.data4wallonia.be/shapes/> .
@prefix d4w: <http://data4wallonia.com/model/> .
@prefix ex: <http://example.com/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# declare the skos prefix to use it in later SPARQL-based constraints
d4w:
  a owl:Ontology ;
  sh:declare [
    sh:prefix "d4w" ;
    sh:namespace "http://data4wallonia.com/model/"^^xsd:anyURI ;
  ] , [
    sh:prefix "sh" ;
    sh:namespace "https://www.w3.org/ns/shacl#"^^xsd:anyURI ;
  ] .
  
:D4W-Slug a sh:NodeShape ;
  sh:targetSubjectsOf d4w:slug ;
  rdfs:label "A list of checks on the slug property"@en ;
  rdfs:comment "A list of checks on the slug property"@en ;
  sh:property :D4W-Slug-Unique .

:D4W-Slug-Unique a sh:PropertyShape ;
  sh:name "Slug should be unique among instances of the same class"@en ;
  sh:description "Slug should be unique among instances of the same class"@en ;
  sh:severity sh:Violation ;
  sh:path d4w:slug ;
  sh:sparql [
    sh:prefixes d4w: ;
    rdfs:comment "Slug should be unique among instances of the same class"@en ;
    sh:message "[D4W.MO.R1] - Slug should be unique among the instances of the same class (there is concept '{$this}' with the same slug '{$pl}' of concept '{$other}')."@en ;
    sh:select """
    SELECT $this ?other $pl
    WHERE {
      ?this  d4w:slug ?pl .
      ?other d4w:slug ?opl .
      ?this a ?thisClass .
      ?other a ?otherClass .
      FILTER ($this != ?other && ?thisClass = ?otherClass && ?pl = ?opl)
    }""" ;
  ] .

:D4W-Person a sh:NodeShape ;
  sh:targetClass d4w:Person ;
  rdfs:label "A list of checks on the Person class"@en ;
  rdfs:comment "A list of checks on thePerson class"@en ;
  sh:property :D4W-FeaturedEmail-Unique, :D4W-NonFeaturedEmail-Unique .
  
:D4W-FeaturedEmail-Unique a sh:PropertyShape ;
  sh:name "Featured email should be unique among instances of the same class"@en ;
  sh:description "Featured email should be unique among instances of the same class"@en ;
  sh:severity sh:Violation ;
  sh:path d4w:featuredEmail ;
  sh:sparql [
    sh:prefixes d4w: ;
    rdfs:comment "Featured email should be unique among instances of the same class"@en ;
    sh:message "[D4W.MO.R2] - Featured email should be unique among the instances of the same class (there is concept '{$this}' with the same slug '{$pl}' of concept '{$other}')."@en ;
    sh:select """
    SELECT $this ?other $pl
    WHERE {
      ?this  d4w:featuredEmail ?pl .
      ?other d4w:featuredEmail ?opl .
      ?this a ?thisClass .
      ?other a ?otherClass .
      FILTER ($this != ?other && ?thisClass = ?otherClass && ?pl = ?opl)
    }""" ;
  ] .
  
:D4W-NonFeaturedEmail-Unique a sh:PropertyShape ;
  sh:name "Non featured email should be unique among instances of the same class"@en ;
  sh:description "Non featured email should be unique among instances of the same class"@en ;
  sh:severity sh:Violation ;
  sh:path d4w:nonFeaturedEmail ;
  sh:sparql [
    sh:prefixes d4w: ;
    rdfs:comment "Non featured email should be unique among instances of the same class"@en ;
    sh:message "[D4W.MO.R3] - Non featured email should be unique among the instances of the same class (there is concept '{$this}' with the same slug '{$pl}' of concept '{$other}')."@en ;
    sh:select """
    SELECT $this ?other $pl
    WHERE {
      ?this  d4w:nonFeaturedEmail ?pl .
      ?other d4w:nonFeaturedEmail ?opl .
      ?this a ?thisClass .
      ?other a ?otherClass .
      FILTER ($this != ?other && ?thisClass = ?otherClass && ?pl = ?opl)
    }""" ;
  ] .

:D4W-Email-AtLeast1 a sh:NodeShape ;
  sh:targetClass d4w:Person ;
  rdfs:label "A person should have at least 1 email"@en ;
  rdfs:comment "A person should have at least 1 email"@en ;
  sh:message "[D4W.MO.R4] - A person should have at least 1 email"@en ;
  sh:severity sh:Violation ;
  sh:or (
	[
		sh:path d4w:featuredEmail ;
        sh:minCount 1 ;
	]
	[
		sh:path d4w:nonFeaturedEmail;
        sh:minCount 1 ;
	]
  ) .

