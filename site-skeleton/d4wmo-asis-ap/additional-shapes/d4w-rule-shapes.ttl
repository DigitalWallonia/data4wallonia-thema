@prefix : <https://www.data4wallonia.be/shapes/> .
@prefix d4w: <http://data4wallonia.com/model/> .
@prefix ex: <http://example.com/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# declare the skos prefix to use it in later SPARQL-based constraints
d4w:
  a owl:Ontology ;
  sh:declare [
    sh:prefix "d4w" ;
    sh:namespace "http://data4wallonia.com/model/"^^xsd:anyURI ;
  ] , [
    sh:prefix "sh" ;
    sh:namespace "https://www.w3.org/ns/shacl#"^^xsd:anyURI ;
  ] .

:D4W-Rule-Slug a sh:NodeShape ;
  sh:targetSubjectsOf d4w:slug ;
  sh:name "slug should be unique among instances of the same class"@en ;
  sh:description "slug should be unique among instances of the same classs"@en ;
  sh:severity sh:Violation ;
  sh:sparql [
    sh:prefixes d4w: ;
    rdfs:comment "slug should be unique among instances of the same class"@en ;
    sh:message "[D4W-R1] - slug should be unique among the same class instances (there is concept '{$this}' with the same slug '{$pl}' of concept '{$other}')."@en ;
    sh:select """
    SELECT $this ?other $pl
    WHERE {
      ?this  d4w:slug ?pl .
      ?other d4w:slug ?opl .
      ?this a ?thisClass .
      ?other a ?otherClass .
      FILTER ($this != ?other && ?thisClass = ?otherClass && ?pl = ?opl)
    }""" ;
  ] .


